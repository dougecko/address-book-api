# Address Book API

This address book application allows a branch manager to keep track of their customer contacts.

The application exposes endpoints for customer contacts:
- add contact (POST to /contacts)
- remove contact (DELETE to /contacts/{contactId})
- get single contact (GET to /contacts/{contactId})
- get all contacts (GET to /contacts)

and address books:

- add book (POST to /books)
- remove book (DELETE to /books/{bookId})
- get single book (GET to /books/{bookId})
- get all books (GET to /books)

and the intersection between contact and book:

- get all contacts in a book (GET to /books/{bookId}/contacts)
- get unique contacts from specified books (POST to /uniquecontacts)

(All these endpoints may optionally include a trailing slash.)

The following utility endpoints are also available: 
- swagger-ui API spec is served from /api-docs
- H2 database console is served from /db (user = sa, no password)

Standard Spring Boot actuator endpoints are enabled, including:
- health check: /actuator/health

## Instructions

### Prerequisites

- Java 11+ (developed in 17, but not using any language features)
- Gradle 7 (should be installed by gradle wrapper on first run)

### Build and test

To download dependencies and compile:

    $ ./gradlew build  

To run unit tests:

    $ ./gradlew test

Reports are generated in:

- build/reports/tests/test/index.html (results)
- build/reports/jacoco/test/html/index.html (coverage)

### Run

To start the application:

    $ ./gradlew bootRun

### Docker

To build the application jar:

    $ ./gradlew assemble

To build Docker image:

    $ ./gradlew assemble
    $ mkdir -p build/dependency
    $ cd build/dependency
    $ jar -xf ../libs/aba-0.0.1-SNAPSHOT.jar
    $ cd ../..
    $ docker build --build-arg JAR_FILE=build/libs/\*.jar -t shine/aba .

or (on Mac/Linux):

    $ chmod u+x docker-build.sh
    $ ./docker-build.sh

To run docker container:

    $ docker run -p 9999:9999 -t shine/aba

## Logging

Application logs can be found in `/logs/spring-boot-logger.log`, containing
HTTP access, error details and other normal Spring logs.

## Persistence

Spring JPA is used to persist to an in-memory H2 database.  This is recreated on every application restart.

## Continuous Integration

When code is pushed to the main branch, this pipeline builds and runs tests:

https://github.com/dougecko/address-book-api/actions

## Assumptions

- both name and phone number must be populated
- phone number must be valid to be dialled from Australia
- adding an existing contact should fail
- updating a non-existent contact should fail
- a simple error code is sufficient (rather than a detailed JSON error response)
- “print" all contacts means “return all contacts in JSON response"
- "maintain" multiple address books means exposing CRUD endpoints
- APIs don't need versioning (yet)

## Design Choices

- use constructor injection for required fields, setter injection for optional fields (none), and not use field injection for anything
- use Google phone validation lib rather than a regex
- builder doesn't include id because it's autogenerated (other than in test data)
- no need for spring profiles in this spike
- no need to separate response objects from JPA DTOs
- use swagger-ui for API spec, autogenerated
- slightly more complicated dockerfile using exploded jar in layers, allows improved caching

## Testing
- unit tests over Service, SpringContext loaded, high coverage
- no tests required over Repository as it's pure spring-data-jpa
- no complex business logic exists that requires unit testing without Spring Boot
- integration tests over Controller
  - happy path
  - exceptions converted to HTTP codes
- integration tests using real endpoints to set up test data were preferred to heavy mocking in unit tests

### Endpoint Test Examples

#### Add contact

    $ curl -X POST localhost:9999/contacts -H 'Content-Type: application/json' -d '{"name":"Dr Tester","phone":"9123 4242"}'

#### Remove contact

    $ curl -X DELETE localhost:9999/contacts/1

#### Get single contact

    $ curl localhost:9999/contacts/2

#### Get all contacts

    $ curl localhost:9999/contacts

#### Add book

    $ curl -X POST localhost:9999/books -H 'Content-Type: application/json' -d '{"name":"Phonebook","contacts": [{"id": "2"}]}'

#### Remove book

    $ curl -X DELETE localhost:9999/books/3

#### Get single book

    $ curl localhost:9999/books/3

#### Get all books

    $ curl localhost:9999/books

#### Get all contacts in a book

    $ curl localhost:9999/books/3/contacts

#### Get unique contacts from specified books

    $ curl -X POST localhost:9999/uniquecontacts -H 'Content-Type: application/json' -d '{"bookIds": [3]}'

## Known Issues

- when adding a book, the non-id fields of the contact are not returned from the POST, but can be retrieved from the GET subsequently 

## Possible Extensions (not implemented)
- API spec: add comments, error codes and the phone validation rules
- CI stages: automated linting, spotbugs, static code analysis and/or security / vulnerability checks
- Security: user authorisation etc
- Logging: increased detail for monitoring and alerting
- Performance: ensure app can support production load (x3?)
- Prod release pipeline: synthetic tests, canary deployments
